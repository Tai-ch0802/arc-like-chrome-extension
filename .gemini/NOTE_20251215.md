# Session Note - 2025-12-15

## 目標
修復書籤拖曳功能在 Virtual Scrolling 模式下的問題，最終採用「方案 G：動態渲染」取代 Virtual Scrolling。

## 完成項目

### Phase 1：移除 Virtual Scrolling
| 檔案 | 變更內容 |
|------|---------|
| `stateManager.js` | 移除 `isVirtualScrolling`、`initVirtualScrolling`、`setVirtualScrollingEnabled` |
| `themeManager.js` | 移除設定面板中的 Virtual Scrolling 開關 |
| `bookmarkRenderer.js` | 移除 `renderBookmarksVirtual`、`createVirtualBookmarkItem`、`createVirtualFolderItem` 及相關 import |
| `searchManager.js` | 移除 `flattenBookmarkTree` import 和 Virtual 模式分支 |
| `sidepanel.js` | 移除 `initVirtualScrolling()` 呼叫 |
| `sidepanel.css` | 移除 `.virtual-scroll-container` 和 `.virtual-item` 樣式 |
| `virtualScrollUtils.js` | 刪除整個檔案 |
| `GEMINI.md` | 移除 `virtualScrollUtils.js` 項目 |

### Phase 2：實作動態渲染
| 檔案 | 變更內容 |
|------|---------|
| `bookmarkRenderer.js` | 資料夾收合時不渲染子項目，展開時才動態渲染並發送 `folderExpanded` 事件 |
| `sidepanel.js` | 新增 `folderExpanded` 事件監聽器，資料夾展開後重新初始化 Sortable |
| `dragDropManager.js` | 新增 `draggable: '.bookmark-item, .bookmark-folder'` 過濾器 |

## 關鍵問題與解決

### 問題 1：Sortable 將 `.folder-content` 視為可拖曳元素
**原因**：Sortable 沒有設定 `draggable` 選項  
**解決**：新增 `draggable: '.bookmark-item, .bookmark-folder'`

### 問題 2：資料夾展開後 Sortable 沒有重新初始化
**原因**：`dragDrop.initialize()` 從未被呼叫，`folderExpanded` 事件監聽器未註冊  
**解決**：在 `sidepanel.js` 的 `initialize()` 中直接註冊事件監聽器

### 問題 3：時序問題導致 Sortable 初始化不穩定
**解決**：使用 `setTimeout(..., 50)` 確保 DOM 渲染完成後再觸發事件

## Commits
- `edeb5fe` feat: implement dynamic rendering for bookmark folders

## 後續建議
- 考慮在 `dragDropManager.js` 中清理未使用的 `initialize()` 函式
- 可進一步優化：收合資料夾時清除子項目 DOM 以減少記憶體使用
