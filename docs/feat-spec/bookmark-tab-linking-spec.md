# 功能規格：書籤與分頁關聯 (Arc-Style Linking)

這份文件描述了「書籤與分頁關聯」功能的開發規格，旨在建立書籤和分頁之間更緊密的連結，優化使用者管理重複分頁的體驗。

## 1. 關聯模型

- **核心儲存:** 使用 `chrome.storage.local` 來持久化儲存書籤與分頁的關聯，確保瀏覽器重啟後狀態不遺失。
- **資料結構:** 採用 Key-Value 結構，Key 為書籤 ID，Value 為一個包含多個分頁 ID 的陣列。
  ```json
  {
    "bookmarkId-123": [tabId-456, tabId-789]
  }
  ```
- **程式碼位置:** 狀態管理的核心邏輯將封裝在 `modules/stateManager.js` 中，並透過 `modules/apiManager.js` 進行儲存操作。

## 2. 建立關聯的場景

系統需在以下兩種主要場景中建立書籤與分頁的關聯：

- **A. 點擊書籤時:**
  - 攔截書籤的預設點擊行為。
  - 透過 `chrome.tabs.create` 以程式化方式開啟新分頁。
  - 記錄新建立的 `tabId` 與被點擊的 `bookmarkId` 的關聯。

- **B. 拖曳分頁至書籤時:**
  - 修改 `modules/dragDropManager.js` 的行為。
  - 當一個分頁被拖曳至書籤區並成功建立新書籤後。
  - 立即記錄該**原始分頁**的 ID 與**新書籤**的 ID 之間的關聯。

## 3. 關聯的同步與維護

為了確保資料的準確性，系統必須監聽以下事件並自動維護關聯模型：

- **分頁事件監聽 (`chrome.tabs`):**
  - `onRemoved`: 當分頁被關閉時，從關聯模型中移除對應的 `tabId`。
  - `onUpdated`: 當分頁的 URL 發生改變時，斷開此分頁與書籤的關聯，因為它已不再代表書籤的原始位置。

- **書籤事件監聽 (`chrome.bookmarks`):**
  - `onRemoved`: 當書籤被刪除時，清除其在關聯模型中的所有記錄。
  - `onChanged`: 當書籤的 URL 被修改時，斷開所有與此書籤關聯的分頁連結，以確保資料一致性。

## 4. UI/UX

- **動態圖示:**
  - 在 `modules/uiManager.js` 中修改渲染邏輯。
  - 當一個書籤在關聯模型中存在至少一個活躍的分頁連結時，其旁邊會顯示一個「已關聯」圖示。
  - 當所有關聯分頁都被關閉或斷開連結後，此圖示會自動消失。

- **關聯分頁資訊面板:**
  - 點擊「已關聯」圖示後，會彈出一個全螢幕的浮動面板。
  - 面板會列出該書籤下所有關聯分頁的即時資訊，至少包含：
    - 分頁的 Favicon
    - 分頁當前標題
    - 分頁所屬的群組名稱（如果有的話）
  - 面板提供關閉按鈕。
