# SA: é­”æ³•ä¸€éµæ•´ç† (Smart Auto-Grouping)

## 1. æ¶æ§‹èˆ‡æ¨¡çµ„è¨­è¨ˆ (Architecture & Modules)

æœ¬åŠŸèƒ½å°‡æ•´åˆè‡³ç¾æœ‰çš„å´é‚Šæ¬„æ¶æ§‹ä¸­ï¼Œä¸»è¦æ¶‰åŠ UI æ¸²æŸ“ã€Chrome API æ“ä½œèˆ‡ç‹€æ…‹ç®¡ç†ã€‚

### 1.1 æ ¸å¿ƒæ¨¡çµ„å½±éŸ¿å€å¡Š
- **`modules/ui/aiGrouperUI.js` (æ–°å¢)**: ç‚ºäº†é™ä½èˆ‡åŸæœ‰ç¨‹å¼ç¢¼çš„è€¦åˆï¼Œç¨ç«‹å‡ºä¸€æ”¯æ–°çš„ UI æ¨¡çµ„è² è²¬å¯¦ä½œã€Œâœ¨ æ™ºæ…§æ•´ç†ã€æŒ‰éˆ•ã€Loading å‹•ç•«ã€ä»¥åŠ Undo UI æç¤ºã€‚ä¸ç›´æ¥ä¿®æ”¹ `tabRenderer.js` å…§éƒ¨æ ¸å¿ƒé‚è¼¯ã€‚
- **`modules/apiManager.js`**: å°è£ Chrome Tab Groups ç›¸é—œ API æ“ä½œï¼ˆå¦‚ `chrome.tabs.group`ã€`chrome.tabGroups.update`ã€`chrome.tabs.ungroup`ï¼‰ã€‚
- **`modules/aiManager.js` (æ–°å¢)**: ç‚ºäº†ç¶­æŒé—œæ³¨é»åˆ†é›¢ï¼Œæ–°å¢æ­¤æ¨¡çµ„å°ˆé–€è™•ç†èˆ‡ `window.ai` (Gemini Nano) çš„æºé€šã€Prompt å»ºæ§‹ã€ä»¥åŠå›æ‡‰è§£æã€‚
- **`modules/stateManager.js`**: è¨˜éŒ„æœ€è¿‘ä¸€æ¬¡æ“ä½œçš„ Undo ç‹€æ…‹ (åŒ…å«å½±éŸ¿çš„ Tab IDs èˆ‡æ–°å»ºçš„ Group IDs)ã€‚

### 1.2 ç³»çµ±æµç¨‹ (System Flow)

```mermaid
sequenceDiagram
    participant User
    participant UI as UI Manager
    participant AI as AI Manager (window.ai)
    participant Chrome as Chrome API (apiManager)
    participant State as State Manager

    User->>UI: é»æ“Šã€Œâœ¨ æ™ºæ…§æ•´ç†ã€
    UI->>UI: é¡¯ç¤º Loading / åœç”¨æŒ‰éˆ•
    UI->>Chrome: ç²å–æœªåˆ†é¡åˆ†é åˆ—è¡¨ (groupId: NONE)
    Chrome-->>UI: è¿”å› [Tabs]
    
    alt åˆ†é æ•¸ < 4
        UI->>User: é¡¯ç¤ºæç¤ºã€Œåˆ†é æ•¸é‡éå°‘ã€
        UI->>UI: æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    else åˆ†é æ•¸ >= 4
        UI->>AI: å‚³é€åˆ†é è³‡æ–™ (Titles & URLs)
        AI-->>AI: å»ºæ§‹ Prompt ä¸¦å‘¼å« window.ai
        AI-->>UI: è¿”å›åˆ†é¡çµæœ (Categories & mapped Tab IDs)
        
        UI->>Chrome: æ ¹æ“šåˆ†é¡å»ºç«‹ Tab Groups
        Chrome-->>UI: è¿”å›æ–°å»ºçš„ Group IDs
        
        UI->>State: å„²å­˜ Undo å¿«å– (Tab IDs, Group IDs)
        UI->>User: é¡¯ç¤ºæˆåŠŸæç¤ºèˆ‡ Undo æŒ‰éˆ•
        UI->>UI: æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    end
```

## 2. API èˆ‡è³‡æ–™çµæ§‹è¨­è¨ˆ (API & Data Design)

### 2.1 Prompt è¨­è¨ˆ (AI Manager)
ç‚ºäº†è®“ Gemini Nano èƒ½ç©©å®šè¼¸å‡ºæ ¼å¼åŒ–çµæœï¼Œå°‡è¨­è¨ˆ System Prompt èˆ‡ User Promptï¼Œä¸¦è¦æ±‚è¼¸å‡º JSON æ ¼å¼çš„å¤§ç¶±ã€‚
**ç¯„ä¾‹ Prompt çµæ§‹**:
```text
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„åˆ†é æ•´ç†åŠ©æ‰‹ã€‚è«‹å°‡ä»¥ä¸‹åˆ†é æ¸…å–®ï¼Œä¾æ“šèªæ„åˆ†é¡æˆ 3 åˆ° 5 å€‹ç¾¤çµ„ã€‚
æ¯å€‹ç¾¤çµ„çµ¦äºˆä¸€å€‹é©åˆçš„ Emoji èˆ‡ç°¡çŸ­ä¸»é¡Œåç¨±ï¼ˆå¦‚ "ğŸ› ï¸ é–‹ç™¼å·¥å…·"ï¼‰ã€‚
è«‹ä»¥ JSON é™£åˆ—æ ¼å¼å›å‚³ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
[
  { "theme": "ğŸ› ï¸ é–‹ç™¼å·¥å…·", "tabIds": [12, 15] },
  ...
]

[åˆ†é æ¸…å–®]
ID: 12 | Title: React Docs | URL: https://react.dev
ID: 15 | Title: MDN Web Docs | URL: https://developer.mozilla.org
...
```

### 2.2 Undo ç‹€æ…‹çµæ§‹ (State Manager)
```javascript
// stateManager.js ä¸­ç¶­è­·çš„ Undo çµæ§‹
let lastAutoGroupState = {
  canUndo: false,
  timestamp: null,
  affectedTabs: [], // è¢«ç§»å‹•çš„åˆ†é  ID é™£åˆ—
  createdGroups: [] // æ–°å»ºçš„ç¾¤çµ„ ID é™£åˆ—
};
```

### 2.3 Chrome API å°è£ (apiManager.js æ–°å¢/æ“´å……)
- `groupTabs(tabIds: number[]): Promise<number>` (å°‡åˆ†é åŠ å…¥æ–°ç¾¤çµ„ï¼Œå›å‚³ groupId)
- `updateTabGroup(groupId: number, options: {title: string}): Promise<void>` (è¨­å®šç¾¤çµ„åç¨±èˆ‡é¡è‰²)
- `ungroupTabs(tabIds: number[]): Promise<void>` (å°‡åˆ†é ç§»å‡ºç¾¤çµ„)

## 3. éœ€æ±‚è¿½æº¯çŸ©é™£ (Requirement Traceability Matrix)

| PRD éœ€æ±‚ç·¨è™Ÿ | éœ€æ±‚æè¿° | æŠ€è¡“å¯¦ä½œå°æ‡‰ | æ¸¬è©¦/é©—è­‰é» |
| :--- | :--- | :--- | :--- |
| FR-1.01 | æä¾›ã€Œâœ¨ æ™ºæ…§æ•´ç†ã€å…¥å£ | `tabRenderer.js` æ³¨å…¥æ•´ç†æŒ‰éˆ• | ç¢ºèªæŒ‰éˆ•åœ¨å´é‚Šæ¬„å¯è¦‹ä¸”å¯é»æ“Š |
| FR-1.02 | æ•¸é‡ä½æ–¼ 4 å€‹é˜²å‘†æç¤º | é»æ“Šäº‹ä»¶ä¸­æª¢æŸ¥ `apiManager.getUnclassifiedTabs().length < 4` | æ¸¬è©¦ 1~3 å€‹æœªåˆ†é¡åˆ†é çš„æƒ…æ³ |
| FR-1.03 | æ“·å–æ¨™é¡Œèˆ‡ç¶²å€ | ä½¿ç”¨ `chrome.tabs.query` éæ¿¾è³‡æ–™ä¸¦çµ„è£å­—ä¸² | ç¢ºèª Prompt å…§æ–‡åŒ…å«æ­£ç¢ºçš„åˆ†é è³‡è¨Š |
| FR-1.04 | è™•ç†æœŸé–“çš„ Loading | é»æ“Šå¾Œè¨­å®šæŒ‰éˆ• CSS class ç‚º loading ç‹€æ…‹ | ç¢ºèªç­‰å¾…æ¨¡å‹å›æ‡‰æ™‚ç•«é¢æœ‰å›é¥‹ |
| FR-1.05 | Gemini Nano æ­¸é¡èˆ‡å‘½å | æ–°å¢ `aiManager.js` è² è²¬ Prompt å»ºæ§‹èˆ‡ JSON è§£æ | ç¢ºèªæ˜¯å¦ç”¢å‡º 3~5 åˆ†é¡ä¸”å¸¶æœ‰ Emoji |
| FR-1.06 | è‡ªå‹•ç§»å…¥æ–°å»ºç¾¤çµ„ | ä¾è§£æçµæœå‘¼å« `chrome.tabs.group` èˆ‡ `update` è¨­å®šæ¨™é¡Œ | è§€å¯Ÿ Chrome ç€è¦½å™¨ä¸Šæ–¹æ˜¯å¦æ­£ç¢ºç”¢ç”Ÿç¾¤çµ„ |
| FR-1.07 | æˆåŠŸæç¤ºèˆ‡å¾©åŸé¸é … | å‘¼å«å°ˆæ¡ˆæ—¢æœ‰çš„ Toast/Notification UI å…ƒä»¶ï¼Œé¡¯ç¤º Undo æŒ‰éˆ• | ç¢ºèªåŸ·è¡ŒæˆåŠŸå¾Œæç¤ºå‡ºç¾ 5 ç§’ï¼Œä¸”æœ‰æŒ‰éˆ• |
| FR-1.08 | æ”¯æ´å¾©åŸ (Undo) è§£æ•£ç¾¤çµ„ | è®€å–å¿«å–ï¼Œå°å—å½±éŸ¿ `tabIds` å‘¼å« `chrome.tabs.ungroup` | é»æ“Š Undo å¾Œï¼Œåˆ†é æ¢å¾©åŸç‹€ä¸”ç¾¤çµ„æ¶ˆå¤± |

## 4. æ½›åœ¨å‰¯ä½œç”¨èˆ‡é€²éšé‚Šç•Œæƒ…æ³ (Potential Side Effects & Edge Cases)

åœ¨ç³»çµ±æ¨æ¼”ä¸­ï¼Œè¾¨è­˜å‡ºä»¥ä¸‹å¯èƒ½å½±éŸ¿åŸæœ‰ç³»çµ±çš„è¡Œç‚ºæˆ–æ½›åœ¨é›·å€ï¼š

### 4.1 ç‹€æ…‹ç«¶æ…‹ (Race Conditions) å°è‡´çš„ä¾‹å¤–
1. **åˆ†é åœ¨ AI è™•ç†æœŸé–“ç™¼ç”Ÿè®ŠåŒ– (è¢«æ‰‹å‹•é—œé–‰æˆ–ç§»å‹•)**:
   - *å•é¡Œ*: ç•¶å‰å‚³é€ `tabIds` æ¸…å–®çµ¦ AI åˆ†æï¼ˆéœ€ç­‰å¾… 2~5 ç§’ï¼‰å¾Œï¼Œè‹¥æ­¤æœŸé–“å…§ä½¿ç”¨è€…å·²ç¶“æ‰‹å‹•é—œé–‰æˆ–å°‡æŸäº› Tab ç§»å…¥å…¶ä»– Groupï¼Œæ­¤æ™‚å†é‡å°é€™äº›èˆŠ `tabIds` å‘¼å« `chrome.tabs.group` æœƒå¼•ç™¼ API Errorï¼ˆæ‰¾ä¸åˆ°è©² tabIdï¼‰ã€‚
   - *å°ç­–*: å‘¼å« `chrome.tabs.group` å‰ï¼Œå¿…é ˆé‡æŠ“ä¸€æ¬¡ç•¶ä¸‹æœªåˆ†é¡çš„ `tabIds` ä¸¦å–äº¤é›† (Intersection)ï¼Œä¸Ÿæ£„å·²ç¶“ç„¡æ•ˆçš„ tabIdã€‚
2. **AI åˆ†ææœŸé–“åˆ‡æ›å·¥ä½œå€æˆ–è¦–çª—**:
   - *å•é¡Œ*: è·¨è¦–çª—æƒ…æ³ä¸‹ï¼ŒåŸè¦–çª—çš„ Tab ID ä»æœ‰æ•ˆï¼Œä½†ç¾¤çµ„ä¸æ‡‰è©²å»ºåœ¨éŒ¯èª¤çš„è¦–çª—ã€‚
   - *å°ç­–*: ä½¿ç”¨ `chrome.tabs.group` æ™‚å¿…é ˆæ˜ç¢ºæŒ‡å®š `createProperties.windowId` ç‚ºç™¼èµ·æ•´ç†è¡Œç‚ºæ™‚çš„ç•¶å‰è¦–çª—ï¼Œé˜²æ­¢æ··äº‚ã€‚

### 4.2 Undo (å¾©åŸæ©Ÿåˆ¶) çš„è¤‡é›œåº¦é™·é˜±
3. **Undo æ™‚ç¾¤çµ„å·²è¢«æ‰‹å‹•ä¿®æ”¹**:
   - *å•é¡Œ*: è‹¥åŸ·è¡Œå®Œæ™ºæ…§æ•´ç†å¾Œï¼Œä½¿ç”¨è€…è‡ªè¡Œæ‹–æ›³æˆ–è§£æ•£äº†éƒ¨åˆ†ç”¢ç”Ÿçš„ç¾¤çµ„ï¼Œæ­¤æ™‚å†é»æ“Šã€ŒUndoã€æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ
   - *å°ç­–*: Undo é‚è¼¯æ‡‰è¨­è¨ˆç‚ºã€Œåªé‚„åŸç•¶æ™‚è¢« AI æ‰“åŒ…é€²å»çš„é‚£äº›ç‰¹å®šçš„ Tab IDs (ç§»å‡ºç¾¤çµ„)ã€ã€‚ä¸å»å¼·åŠ›ç æ‰ç•¶æ™‚æ–°å»ºç¾¤çµ„çš„ IDï¼Œè®“ç©ºç¾¤çµ„è‡ªç„¶æ¶ˆå¤± (Chrome è¡Œç‚º) æˆ–æ˜¯ç•™è‘—ï¼Œè€Œä¸æ˜¯ç¡¬ç ã€‚
4. **Undo çš„æŒä¹…åŒ–èˆ‡æœ‰æ•ˆæœŸé™**:
   - *å•é¡Œ*: Undo UI æœƒä¸€ç›´å­˜åœ¨é‚„æ˜¯æœƒåœ¨é‡æ•´é é¢å¾Œæ¶ˆå¤±ï¼Ÿ
   - *å°ç­–*: Undo UI æ‡‰è¨­å®šè¶…æ™‚æ©Ÿåˆ¶ (ä¾‹å¦‚ 10 ç§’å¾Œæ·¡å‡ºæ¶ˆå¤±)ï¼Œä¸”ä¸éœ€è¦å­˜å…¥ localStorage è·¨ session (å›  Tab ID åœ¨é‡å•Ÿå¾Œæœƒæ”¹è®Š)ï¼Œåƒ…é™å®šæ–¼ç•¶ä¸‹ç•«é¢æç¤ºéšæ®µæœ‰æ•ˆã€‚

### 4.3 AI æ¨¡å‹çš„ä¸ç¢ºå®šæ€§ (Model Uncertainty)
5. **æ¨¡å‹å›å‚³ç„¡æ³•è§£æçš„å­—ä¸²**:
   - *å•é¡Œ*: å³ä½¿ç”¨ Prompt è¦æ±‚ JSONï¼ŒGemini Nano æœ‰æ™‚ä»æœƒå¸¶æœ‰ Markdown code block (````json ... ````) æˆ–é¡å¤–å‰å¾Œæ–‡å°è©±ã€‚
   - *å°ç­–*: `aiManager.js` å¿…é ˆå…·å‚™æ¸…æ´—é‚è¼¯ï¼Œåˆ©ç”¨ Regex `/\[\s*\{.*\}\s*\]/s` extraction ä¾†ç²¾æº–æå–é™£åˆ—å…§å®¹ï¼Œä¸¦åŠ ä¸Š `try...catch` é€²è¡Œ `JSON.parse`ã€‚è‹¥å¤±æ•—éœ€é€²å…¥å®¹éŒ¯è™•ç† (ä¾‹å¦‚ fallback ç‚ºä¸€å€‹åç‚ºã€ŒğŸ“¦ æœªçŸ¥åˆ†é¡ã€çš„ç¾¤çµ„)ã€‚
6. **è¢«æ­¸é¡çš„åˆ†é æ•¸è¶…å‡º Token ä¸Šé™**:
   - *å•é¡Œ*: `window.ai` çš„ token `maxTokens` é™åˆ¶ï¼Œå¦‚æœé€é€²å» 50 å€‹ `Title` å’Œ `URL` æœƒç™¼ç”Ÿå¡æ­»æˆ–è¶…å‡ºã€‚
   - *å°ç­–*: åœ¨çµ„è£ Prompt ä¹‹å‰ï¼Œå°æœªåˆ†é¡åˆ—è¡¨é€²è¡Œã€Œå‰ N å€‹ã€æˆªæ–·ï¼ˆå¦‚åªå–å‰ 30 å€‹åˆ†é è™•ç†ï¼‰ï¼Œä¸¦ç¸®çŸ­éé•·çš„ Title å’Œ URLã€‚è¶…é 30 å€‹çš„åˆ†é åœ¨æ­¤æ¬¡æ“ä½œå…ˆè¢«å¿½ç•¥ä¸ä¸Ÿçµ¦ AIï¼Œç¢ºä¿æ ¸å¿ƒç³»çµ±ç©©å®šä¸æ­»æ©Ÿã€‚

### 4.4 å…¶ä»–å‘¨é‚Šå½±éŸ¿ (Peripheral Side Effects)
7. **ç„¡ç—•æ¨¡å¼ (Incognito) çš„é™åˆ¶**:
   - *å•é¡Œ*: ç„¡ç—•æ¨¡å¼ä¸‹çš„åˆ†é ç¾¤çµ„è¡Œç‚ºå¯èƒ½å—åˆ°ç€è¦½å™¨é™åˆ¶æˆ–ç„¡æ³•ä¿å­˜ã€‚
   - *å°ç­–*: `apiManager` éœ€åœ¨ç„¡ç—•è¦–çª—ä¸­åˆ¤å®šæ˜¯å¦è·³éæˆ–æä¾›ç›¸æ‡‰çš„æç¤ºã€‚
8. **æ“´å……åŠŸèƒ½é‡ç–Šè¡çª**:
   - *å•é¡Œ*: å…¶ä»–ä¾‹å¦‚ "Tab Suspender" å·²ç¶“å°‡åˆ†é ä¼‘çœ ï¼ˆURL å¯èƒ½è®Šæˆ chrome-extension://...ï¼‰ï¼Œé€™æœƒå½±éŸ¿ AI æŠ“å–çš„ URL è­˜åˆ¥ã€‚
   - *å°ç­–*: ç›¡å¯èƒ½å–®ç´”ä½¿ç”¨ Title åˆ¤è®€ï¼Œæˆ–è€…è§£æä¼‘çœ é é¢çš„çœŸå¯¦ URLï¼Œä½†åœ¨ MVP éšæ®µå…ˆå°‡å…¶è¦–ç‚ºä¸€èˆ¬ Title å³å¯ã€‚
